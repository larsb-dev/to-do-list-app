services:
  php:
    container_name: php
    image: my-laravel-app
    build:
      context: .docker/php
      dockerfile: Dockerfile
      target: development
      args:
        # First looks at .env, then falls back to defaults
        USER: ${APP_USER:-appuser}
        USERID: ${APP_USER_UID:-1000}
        GROUPID: ${APP_USER_GID:-1000}
    ports:
      - '80:80'
    volumes:
      - '.:/app'
    depends_on:
      - db
      - redis
    restart: unless-stopped
    networks:
      - backend
    user: '${APP_USER_UID:-1000}:${APP_USER_GID:-1000}'
    cap_add:
      - NET_BIND_SERVICE
    working_dir: /app
    command: frankenphp php-server

  db:
    container_name: db
    image: postgres:18.0
    environment:
      POSTGRES_USER_FILE: /run/secrets/pg_user
      POSTGRES_DB: my_laravel_db
      POSTGRES_PASSWORD_FILE: /run/secrets/pg_password
      TZ: Europe/Zurich
      PGTZ: Europe/Zurich
    secrets:
      - pg_user
      - pg_password
    volumes:
      - my-laravel-database:/var/lib/postgresql
    restart: unless-stopped
    networks:
      - backend
    ports:
      - '5432:5432'

  redis:
    container_name: redis
    image: redis:alpine
    volumes:
      - my-laravel-redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      retries: 3
      timeout: 5s
    restart: unless-stopped
    networks:
      - backend
    ports:
      - '6379:6379'

  artisan:
    image: my-laravel-app
    volumes:
      - '.:/app'
    depends_on:
      - php
      - db
      - redis
    entrypoint: 'frankenphp php-cli artisan'
    restart: no
    networks:
      - backend
    user: '${APP_USER_UID:-1000}:${APP_USER_GID:-1000}'

secrets:
  pg_user:
    file: .secrets/pg_user
  pg_password:
    file: .secrets/pg_password

volumes:
  my-laravel-database:
  my-laravel-redis-data:

networks:
  backend:
